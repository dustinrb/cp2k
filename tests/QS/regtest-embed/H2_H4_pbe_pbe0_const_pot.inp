!
!  Tests level shifting, printing embedding potential cubes
!  and adding a constant part to the embedding potential
!
&GLOBAL
  PRINT_LEVEL HIGH
  PROJECT h4_h8_pbe_pbe0_4_const
  RUN_TYPE ENERGY
&END GLOBAL

&MULTIPLE_FORCE_EVALS
  FORCE_EVAL_ORDER 2 3 4 5
  MULTIPLE_SUBSYS T
&END MULTIPLE_FORCE_EVALS

&FORCE_EVAL
  METHOD EMBED
  &EMBED
    NGROUPS 1
    &MAPPING
      &FORCE_EVAL 1
        &FRAGMENT 1
          1 2
          MAP 1
        &END FRAGMENT
      &END FORCE_EVAL
      &FORCE_EVAL 2
        &FRAGMENT 1
          1 2
          MAP 2
        &END FRAGMENT
      &END FORCE_EVAL
      &FORCE_EVAL 3
        &FRAGMENT 1
          1 4
          MAP 3
        &END FRAGMENT
      &END FORCE_EVAL
      &FORCE_EVAL 4
        &FRAGMENT 1
          1 2
          MAP 2
        &END FRAGMENT
      &END FORCE_EVAL
      &FORCE_EVAL_EMBED
        &FRAGMENT 1
          1 2
        &END FRAGMENT
        &FRAGMENT 2
          3 4
        &END FRAGMENT
        &FRAGMENT 3
          1 4
        &END FRAGMENT
      &END FORCE_EVAL_EMBED
    &END MAPPING
  &END EMBED
  &SUBSYS
    &CELL
      ABC [angstrom] 4.000 4.000 4.000
      PERIODIC NONE
    &END CELL
    &COORD
      H    6.7935     6.0     4.0
      H    7.3225     6.0     4.0
      H    6.2645     6.0     4.0
      H    5.7355     6.0     4.0
    &END COORD
    &KIND H
      BASIS_SET cc-DZ
      BASIS_SET RI_AUX RI_TZ
      !POTENTIAL  GTH-PBE-q1
      POTENTIAL GTH-HF-q1
    &END KIND
    &KIND O
      BASIS_SET cc-DZ
      BASIS_SET RI_AUX RI_TZ
      !POTENTIAL  GTH-PBE-q6
      POTENTIAL GTH-HF-q6
    &END KIND
  &END SUBSYS
&END FORCE_EVAL

! Subsys 1
&FORCE_EVAL
  METHOD Quickstep
  &DFT
    BASIS_SET_FILE_NAME BASIS_RI_cc-TZ
    !POTENTIAL_FILE_NAME  GTH_POTENTIALS
    POTENTIAL_FILE_NAME HF_POTENTIALS
    &MGRID
      CUTOFF 100
      REL_CUTOFF 20
    &END MGRID
    &POISSON
      PERIODIC NONE
      POISSON_SOLVER WAVELET
    &END POISSON
    &PRINT
      &E_DENSITY_CUBE MEDIUM
      &END E_DENSITY_CUBE
    &END PRINT
    &QS
      METHOD GPW
    &END QS
    &SCF
      EPS_SCF 1.0E-6
      MAX_SCF 100
      SCF_GUESS ATOMIC
      &OT
        PRECONDITIONER FULL_ALL
      &END OT
      &PRINT
        &RESTART OFF
        &END RESTART
      &END PRINT
    &END SCF
    &XC
      &XC_FUNCTIONAL PBE
      &END XC_FUNCTIONAL
    &END XC
  &END DFT
  &SUBSYS
    &CELL
      ABC [angstrom] 4.000 4.000 4.000
      PERIODIC NONE
    &END CELL
    &COORD
      H    6.7935     6.0     4.0
      H    7.3225     6.0     4.0
    &END COORD
    &KIND H
      BASIS_SET cc-DZ
      BASIS_SET RI_AUX RI_TZ
      !POTENTIAL  GTH-PBE-q1
      POTENTIAL GTH-HF-q1
    &END KIND
  &END SUBSYS
&END FORCE_EVAL

! Subsys 2
&FORCE_EVAL
  METHOD Quickstep
  &DFT
    BASIS_SET_FILE_NAME BASIS_RI_cc-TZ
    !POTENTIAL_FILE_NAME  GTH_POTENTIALS
    POTENTIAL_FILE_NAME HF_POTENTIALS
    &MGRID
      CUTOFF 100
      REL_CUTOFF 20
    &END MGRID
    &POISSON
      PERIODIC NONE
      POISSON_SOLVER WAVELET
    &END POISSON
    &PRINT
      &E_DENSITY_CUBE MEDIUM
      &END E_DENSITY_CUBE
    &END PRINT
    &QS
      CLUSTER_EMBED_SUBSYS .TRUE.
      METHOD GPW
    &END QS
    &SCF
      EPS_SCF 1.0E-6
      MAX_SCF 100
      SCF_GUESS ATOMIC
      &OT
        PRECONDITIONER FULL_ALL
      &END OT
      &PRINT
        &RESTART OFF
        &END RESTART
      &END PRINT
    &END SCF
    &XC
      &XC_FUNCTIONAL PBE
      &END XC_FUNCTIONAL
    &END XC
  &END DFT
  &SUBSYS
    &CELL
      ABC [angstrom] 4.000 4.000 4.000
      PERIODIC NONE
    &END CELL
    &COORD
      H    6.2645     6.0     4.0
      H    5.7355     6.0     4.0
    &END COORD
    &KIND H
      BASIS_SET cc-DZ
      BASIS_SET RI_AUX RI_TZ
      !POTENTIAL  GTH-PBE-q1
      POTENTIAL GTH-HF-q1
    &END KIND
    &KIND O
      BASIS_SET cc-DZ
      BASIS_SET RI_AUX RI_TZ
      !POTENTIAL  GTH-PBE-q6
      POTENTIAL GTH-HF-q6
    &END KIND
  &END SUBSYS
&END FORCE_EVAL

! Total system
&FORCE_EVAL
  METHOD Quickstep
  &DFT
    BASIS_SET_FILE_NAME BASIS_RI_cc-TZ
    !BASIS_SET_FILE_NAME  HFX_BASIS
    !POTENTIAL_FILE_NAME  GTH_POTENTIALS
    POTENTIAL_FILE_NAME HF_POTENTIALS
    &MGRID
      CUTOFF 100
      REL_CUTOFF 20
    &END MGRID
    &POISSON
      PERIODIC NONE
      POISSON_SOLVER WAVELET
    &END POISSON
    &PRINT
      &E_DENSITY_CUBE MEDIUM
      &END E_DENSITY_CUBE
    &END PRINT
    &QS
      METHOD GPW
      REF_EMBED_SUBSYS .TRUE.
      &OPT_EMBED
        DENS_CONV_INT 1.35
        DENS_CONV_MAX 0.2
        GRID_OPT .FALSE.
        N_ITER 50
        OPTIMIZER LEVEL_SHIFT
        POT_GUESS Fermi_Amaldi
        REG_LAMBDA 0.00001
        TRUST_RAD 0.1
        &EMBED_POT_CUBE MEDIUM
        &END EMBED_POT_CUBE
      &END OPT_EMBED
    &END QS
    &SCF
      EPS_SCF 1.0E-6
      MAX_SCF 100
      SCF_GUESS ATOMIC
      &OT
        PRECONDITIONER FULL_ALL
      &END OT
      &PRINT
        &RESTART OFF
        &END RESTART
      &END PRINT
    &END SCF
    &XC
      &XC_FUNCTIONAL PBE
      &END XC_FUNCTIONAL
    &END XC
  &END DFT
  &SUBSYS
    &CELL
      ABC [angstrom] 4.000 4.000 4.000
      PERIODIC NONE
    &END CELL
    &COORD
      H    6.7935     6.0     4.0
      H    7.3225     6.0     4.0
      H    6.2645     6.0     4.0
      H    5.7355     6.0     4.0
    &END COORD
    &KIND H
      BASIS_SET cc-DZ
      BASIS_SET RI_AUX RI_TZ
      POTENTIAL GTH-HF-q1
    &END KIND
  &END SUBSYS
&END FORCE_EVAL

! Higher level calculation on subsys 2
&FORCE_EVAL
  METHOD Quickstep
  &DFT
    BASIS_SET_FILE_NAME BASIS_RI_cc-TZ
    !POTENTIAL_FILE_NAME  GTH_POTENTIALS
    POTENTIAL_FILE_NAME HF_POTENTIALS
    &MGRID
      CUTOFF 100
      REL_CUTOFF 20
    &END MGRID
    &POISSON
      PERIODIC NONE
      POISSON_SOLVER WAVELET
    &END POISSON
    &PRINT
      &E_DENSITY_CUBE MEDIUM
      &END E_DENSITY_CUBE
    &END PRINT
    &QS
      HIGH_LEVEL_EMBED_SUBSYS
      METHOD GPW
    &END QS
    &SCF
      EPS_SCF 1.0E-6
      MAX_SCF 100
      SCF_GUESS ATOMIC
      &OT
        PRECONDITIONER FULL_ALL
      &END OT
      &PRINT
        &RESTART OFF
        &END RESTART
      &END PRINT
    &END SCF
    &XC
      &HF
        FRACTION 0.25
        &INTERACTION_POTENTIAL
          CUTOFF_RADIUS 4.95
          POTENTIAL_TYPE TRUNCATED
          T_C_G_DATA t_c_g.dat
        &END INTERACTION_POTENTIAL
      &END HF
      &XC_FUNCTIONAL PBE
        &PBE
          SCALE_C 1.0
          SCALE_X 0.75
        &END PBE
      &END XC_FUNCTIONAL
    &END XC
  &END DFT
  &SUBSYS
    &CELL
      ABC [angstrom] 4.000 4.000 4.000
      PERIODIC NONE
    &END CELL
    &COORD
      H    6.2645     6.0     4.0
      H    5.7355     6.0     4.0
    &END COORD
    &KIND H
      BASIS_SET cc-DZ
      BASIS_SET RI_AUX RI_TZ
      !POTENTIAL  GTH-PBE-q1
      POTENTIAL GTH-HF-q1
    &END KIND
  &END SUBSYS
&END FORCE_EVAL
